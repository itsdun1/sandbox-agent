<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction Agent</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --border:    #2a2d3a;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --accent:    #6366f1;
      --user-bg:   #1e3a5f;
      --code-bg:   #0d1117;
      --green:     #22c55e;
      --yellow:    #eab308;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ─────────────────────────────────────────── */
    header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    header h1 { font-size: 15px; font-weight: 600; }

    #thread-meta {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #thread-id {
      font-size: 12px;
      color: var(--muted);
      font-family: monospace;
    }

    #status-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 9999px;
    }
    .badge-hot  { background: rgba(34,197,94,0.12);  color: var(--green);  }
    .badge-warm { background: rgba(234,179,8,0.12);  color: var(--yellow); }
    .badge-cold { background: rgba(100,116,139,0.12);color: var(--muted);  }

    #new-btn {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    #new-btn:hover { background: var(--border); color: var(--text); }

    /* ── Messages ───────────────────────────────────────── */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 28px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* centre column */
    #messages > * {
      max-width: 760px;
      width: 100%;
      margin: 0 auto;
    }

    .msg {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 85%;
    }
    .msg.user      { align-self: flex-end; align-items: flex-end; }
    .msg.assistant { align-self: flex-start; align-items: flex-start; }

    /* full-width wrapper so code blocks can stretch */
    .msg.assistant { max-width: 100%; }

    .msg-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0 4px;
    }

    .msg-inner {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
      width: 100%;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user      .bubble { background: var(--user-bg); border-bottom-right-radius: 4px; }
    .msg.assistant .bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      max-width: 680px;
    }

    /* ── Code block ─────────────────────────────────────── */
    .code-block {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      font-size: 12.5px;
      width: 100%;
      max-width: 680px;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
    }
    .code-header span:first-child { color: var(--accent); font-weight: 600; }

    .code-source {
      padding: 10px 14px;
      font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
      color: #a9b1d6;
      overflow-x: auto;
      white-space: pre;
      line-height: 1.5;
    }

    .code-output {
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
      color: #9ece6a;
      overflow-x: auto;
      white-space: pre;
      line-height: 1.5;
      background: rgba(158,206,106,0.03);
    }
    .output-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    /* ── Status line (ephemeral) ────────────────────────── */
    .status-line {
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      padding: 0 4px;
      animation: fadeIn 0.2s ease;
    }

    /* ── Typing cursor ──────────────────────────────────── */
    .cursor {
      display: inline-block;
      width: 2px;
      height: 13px;
      background: var(--accent);
      border-radius: 1px;
      vertical-align: middle;
      margin-left: 1px;
      animation: blink 0.9s infinite;
    }
    @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    /* ── Empty state ────────────────────────────────────── */
    #empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
      pointer-events: none;
    }
    #empty h2 { font-size: 20px; color: var(--text); margin-bottom: 8px; font-weight: 500; }
    #empty p  { font-size: 14px; }

    /* ── Input area ─────────────────────────────────────── */
    #input-wrap {
      flex-shrink: 0;
      padding: 14px 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }

    #input-row {
      max-width: 760px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    #msg-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      line-height: 1.5;
      resize: none;
      min-height: 44px;
      max-height: 140px;
      outline: none;
      transition: border-color 0.15s;
    }
    #msg-input:focus    { border-color: var(--accent); }
    #msg-input::placeholder { color: var(--muted); }

    #send-btn {
      height: 44px;
      padding: 0 20px;
      background: var(--accent);
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.15s;
    }
    #send-btn:disabled           { opacity: 0.4; cursor: not-allowed; }
    #send-btn:hover:not(:disabled) { opacity: 0.88; }

    /* ── Misc ───────────────────────────────────────────── */
    #messages::-webkit-scrollbar       { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

    .err-banner {
      padding: 12px 16px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      font-size: 13px;
      color: #fca5a5;
      max-width: 680px;
    }
  </style>
</head>
<body>

<header>
  <h1>Transaction Agent</h1>
  <div id="thread-meta">
    <span id="thread-id">—</span>
    <span id="status-badge" class="badge-cold">cold</span>
    <button id="new-btn" onclick="newThread()">+ New Thread</button>
  </div>
</header>

<div id="messages">
  <div id="empty">
    <h2>Transaction Agent</h2>
    <p>Ask me anything about your transactions data.<br/>Press Enter to send, Shift+Enter for a new line.</p>
  </div>
</div>

<div id="input-wrap">
  <div id="input-row">
    <textarea
      id="msg-input"
      placeholder="Ask about your transactions…"
      rows="1"
      onkeydown="handleKey(event)"
      oninput="autoResize(this)"
    ></textarea>
    <button id="send-btn" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
// ── Config ────────────────────────────────────────────────────────
// Empty string = same origin (server serves this page at /ui)
const API = ''

// ── State ─────────────────────────────────────────────────────────
let threadId   = null
let streaming  = false

// ── Boot ──────────────────────────────────────────────────────────
async function init() {
  const params = new URLSearchParams(location.search)
  const tid    = params.get('thread')

  if (tid) {
    threadId = tid
    setThreadLabel(tid)
    await loadHistory(tid)
  } else {
    await createThread()
  }
}

async function createThread() {
  setThreadLabel('creating…')
  setBadge('cold')
  try {
    const res  = await fetch(`${API}/thread/new`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({}),
    })
    const data = await res.json()
    threadId   = data.thread_id
    setThreadLabel(threadId)
    pushURL(threadId)
    setBadge('hot')
  } catch (e) {
    setThreadLabel('error — server running?')
    console.error(e)
  }
}

async function loadHistory(tid) {
  try {
    const res = await fetch(`${API}/thread/${tid}/history`)
    if (!res.ok) { await createThread(); return }   // thread gone → new one

    const { messages } = await res.json()
    const visible = messages.filter(m => m.role === 'user' || m.role === 'assistant')
    if (visible.length) {
      removeEmpty()
      visible.forEach(m => addMessage(m.role, m.content))
    }

    // update status badge
    const sr = await fetch(`${API}/thread/${tid}/status`)
    if (sr.ok) { const s = await sr.json(); setBadge(s.sandbox_status) }
  } catch (e) {
    console.error('loadHistory:', e)
  }
}

function newThread() {
  // strip ?thread= from URL → triggers a fresh thread on reload
  location.href = location.pathname
}

// ── Sending ───────────────────────────────────────────────────────
async function sendMessage() {
  const input = document.getElementById('msg-input')
  const text  = input.value.trim()
  if (!text || streaming || !threadId) return

  input.value = ''
  autoResize(input)
  removeEmpty()

  streaming = true
  document.getElementById('send-btn').disabled = true

  addMessage('user', text)
  const { inner, bubble } = addStreamingMessage()

  try {
    const res = await fetch(`${API}/thread/${threadId}/message/stream`, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
      body:    JSON.stringify({ message: text }),
    })

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }))
      showError(inner, bubble, err.detail || 'Request failed')
      return
    }

    const reader  = res.body.getReader()
    const decoder = new TextDecoder()
    let buf = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      buf += decoder.decode(value, { stream: true })

      // process complete SSE lines
      const lines = buf.split('\n')
      buf = lines.pop()            // keep partial line for next chunk

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue
        let event
        try { event = JSON.parse(line.slice(6)) } catch { continue }
        handleEvent(event, inner, bubble)
      }
    }
  } catch (e) {
    showError(inner, bubble, e.message)
  } finally {
    removeCursor(bubble)
    streaming = false
    document.getElementById('send-btn').disabled = false
    document.getElementById('msg-input').focus()
  }
}

// ── SSE event handler ─────────────────────────────────────────────
function handleEvent(ev, inner, bubble) {
  switch (ev.type) {
    case 'token':
      appendText(bubble, ev.text)
      break

    case 'code_run':
      insertCodeBlock(inner, bubble, ev.code, ev.output, ev.exec_ms)
      break

    case 'status':
      showStatusLine(inner, bubble, ev.text)
      break

    case 'done':
      setBadge(ev.container_state || 'hot')
      break

    case 'error':
      showError(inner, bubble, ev.message)
      break
  }
}

// ── DOM helpers ───────────────────────────────────────────────────

/** Append a fully-rendered message (history load). */
function addMessage(role, content) {
  const wrap = document.createElement('div')
  wrap.className = `msg ${role}`
  const inner = document.createElement('div')
  inner.className = 'msg-inner'
  const bubble = document.createElement('div')
  bubble.className = 'bubble'
  bubble.textContent = content
  inner.appendChild(bubble)
  wrap.innerHTML = `<span class="msg-label">${role === 'user' ? 'You' : 'Agent'}</span>`
  wrap.appendChild(inner)
  document.getElementById('messages').appendChild(wrap)
  scrollDown()
}

/** Create an empty assistant message with a blinking cursor. */
function addStreamingMessage() {
  const wrap   = document.createElement('div')
  wrap.className = 'msg assistant'

  const label  = document.createElement('span')
  label.className = 'msg-label'
  label.textContent = 'Agent'

  const inner  = document.createElement('div')
  inner.className = 'msg-inner'

  const bubble = document.createElement('div')
  bubble.className = 'bubble'

  const cursor = document.createElement('span')
  cursor.className = 'cursor'
  bubble.appendChild(cursor)

  inner.appendChild(bubble)
  wrap.appendChild(label)
  wrap.appendChild(inner)
  document.getElementById('messages').appendChild(wrap)
  scrollDown()
  return { inner, bubble }
}

/** Append plain text to the bubble (keeps cursor at end). */
function appendText(bubble, text) {
  removeCursor(bubble)
  bubble.appendChild(document.createTextNode(text))
  addCursor(bubble)
  scrollDown()
}

/**
 * Insert a code block BEFORE the bubble so it appears
 * above the final text explanation (natural order: code → explanation).
 */
function insertCodeBlock(inner, bubble, code, output, execMs) {
  removeCursor(bubble)

  const block = document.createElement('div')
  block.className = 'code-block'
  block.innerHTML = `
    <div class="code-header">
      <span>Python</span>
      <span>${execMs} ms</span>
    </div>
    <div class="code-source">${esc(code)}</div>
    ${output ? `
    <div class="code-output">
      <div class="output-label">Output</div>${esc(output)}
    </div>` : ''}
  `

  // insert before the bubble so layout is: code → explanation text
  inner.insertBefore(block, bubble)
  addCursor(bubble)
  scrollDown()
}

/** Show a transient italic status line that fades after 4 s. */
function showStatusLine(inner, bubble, text) {
  const line = document.createElement('div')
  line.className = 'status-line'
  line.textContent = text
  inner.insertBefore(line, bubble)
  scrollDown()
  setTimeout(() => line.remove(), 4000)
}

function showError(inner, bubble, message) {
  removeCursor(bubble)
  // if bubble is empty, remove it
  if (!bubble.textContent.trim()) bubble.remove()
  const banner = document.createElement('div')
  banner.className = 'err-banner'
  banner.textContent = `Error: ${message}`
  inner.appendChild(banner)
  scrollDown()
}

function removeCursor(bubble) {
  bubble.querySelector('.cursor')?.remove()
}
function addCursor(bubble) {
  const c = document.createElement('span')
  c.className = 'cursor'
  bubble.appendChild(c)
}

function removeEmpty() {
  document.getElementById('empty')?.remove()
}

// ── Badge & URL ───────────────────────────────────────────────────
function setBadge(state) {
  const badge = document.getElementById('status-badge')
  const base  = /hot/.test(state) ? 'hot' : /warm/.test(state) ? 'warm' : 'cold'
  badge.textContent = state
  badge.className   = `badge-${base}`
}

function setThreadLabel(text) {
  document.getElementById('thread-id').textContent =
    text.length > 20 ? `thread: ${text}` : `thread: ${text}`
}

function pushURL(tid) {
  const u = new URL(location.href)
  u.searchParams.set('thread', tid)
  history.replaceState({}, '', u)
}

// ── Input helpers ─────────────────────────────────────────────────
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() }
}

function autoResize(el) {
  el.style.height = 'auto'
  el.style.height = Math.min(el.scrollHeight, 140) + 'px'
}

function scrollDown() {
  const el = document.getElementById('messages')
  el.scrollTop = el.scrollHeight
}

function esc(str) {
  return (str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
}

// ── Go ────────────────────────────────────────────────────────────
init()
</script>
</body>
</html>
